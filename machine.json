{
  "variables": {
    "do_api_token": "{{env `TOKEN`}}"
  },
  "builders": [{
    "type":         "digitalocean",
    "api_token":    "{{user `do_api_token`}}",
    "ssh_username": "root",
    "image":        "ubuntu-16-04-x64",
    "region":       "ams3",
    "size":         "4gb"
  }],
  "provisioners": [
  {
    "type": "file",
    "source": "./shellinabox.service",
    "destination": "/etc/systemd/system/shellinabox.service"
  },
  {
    "type": "shell",
    "inline": [
      "apt-get update",
      "apt-get install -y apt-transport-https ca-certificates curl software-properties-common",
      "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -",
      "apt-key fingerprint 0EBFCD88",
      "add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"",
      "apt-get update",
      "apt-get install -y docker-ce",
      "apt-get install -y python-pip emacs git htop",
      "systemctl status docker",
      "pip install docker-compose==1.10",
      "groupadd -g 1000 jenkins",
      "useradd -d /home/jenkins -u 1000 -g 1000 -m -s /bin/bash jenkins",
      "echo 'jenkins:doj2017oslo' | chpasswd",
      "ssh-keygen -f $HOME/.ssh/id_rsa -t rsa -N ''",
      "cp -rf $HOME/.ssh /home/jenkins/",
      "chown -R jenkins:jenkins /home/jenkins/.ssh",
      "usermod -aG docker jenkins",
      "apt-get install -y libssl-dev libpam0g-dev zlib1g-dev dh-autoreconf",
      "git clone https://github.com/shellinabox/shellinabox.git",
      "cd shellinabox && autoreconf -i &&  ./configure && make && make install",
      "systemctl daemon-reload",
      "systemctl enable shellinabox.service",
      "systemctl start shellinabox.service"
    ]
  }]
}
